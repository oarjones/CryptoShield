@echo off
REM CryptoShield Installation Script
REM Run as Administrator

setlocal enabledelayedexpansion

echo ===============================================
echo CryptoShield Anti-Ransomware Installation
echo Version 1.0.0
echo ===============================================
echo.

REM Check for administrator privileges
net session >nul 2>&1
if %errorLevel% neq 0 (
    echo ERROR: This script must be run as Administrator!
    echo Right-click and select "Run as administrator"
    pause
    exit /b 1
)

REM Set paths
REM MODIFIED: Changed Release to Debug for DRIVER_PATH based on provided images
set DRIVER_PATH=%~dp0Driver\CryptoShield\x64\Debug\CryptoShield.sys
set DRIVER_INF=%~dp0Driver\CryptoShield\x64\Debug\CryptoShield.inf
REM MODIFIED: Changed Release to Debug for SERVICE_PATH based on provided images
set SERVICE_PATH=%~dp0Driver\CryptoShield\x64\Debug\CryptoShieldService.exe
set INSTALL_DIR=C:\Program Files\CryptoShield
set DATA_DIR=C:\ProgramData\CryptoShield
set LOG_FILE=%DATA_DIR%\install.log

REM Ensure DATA_DIR exists for logging early
if not exist "%DATA_DIR%" mkdir "%DATA_DIR%"
if not exist "%DATA_DIR%\Logs" mkdir "%DATA_DIR%\Logs"

echo Script started on %date% at %time% > "%LOG_FILE%"
echo. >> "%LOG_FILE%"

REM Check if files exist
if not exist "%DRIVER_PATH%" (
    echo ERROR: Driver file not found: %DRIVER_PATH%
    echo ERROR: Driver file not found: %DRIVER_PATH% >> "%LOG_FILE%"
    echo Please build the driver first.
    echo Please build the driver first. >> "%LOG_FILE%"
    pause
    exit /b 1
)

if not exist "%SERVICE_PATH%" (
    echo ERROR: Service file not found: %SERVICE_PATH%
    echo ERROR: Service file not found: %SERVICE_PATH% >> "%LOG_FILE%"
    echo Please build the service first.
    echo Please build the service first. >> "%LOG_FILE%"
    pause
    exit /b 1
)

echo [1/7] Creating installation directories...
echo [1/7] Creating installation directories... >> "%LOG_FILE%"
if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%" >> "%LOG_FILE%" 2>&1
if not exist "%DATA_DIR%" mkdir "%DATA_DIR%" >> "%LOG_FILE%" 2>&1
if not exist "%DATA_DIR%\Logs" mkdir "%DATA_DIR%\Logs" >> "%LOG_FILE%" 2>&1

echo [2/7] Copying files...
echo [2/7] Copying files... >> "%LOG_FILE%"
copy /Y "%SERVICE_PATH%" "%INSTALL_DIR%\" >nul
if %errorLevel% neq 0 (
    echo ERROR: Failed to copy service executable
    echo ERROR: Failed to copy service executable >> "%LOG_FILE%"
    pause
    exit /b 1
)
echo Service executable copied to %INSTALL_DIR% >> "%LOG_FILE%"

echo [3/7] Installing driver...
echo [3/7] Installing driver... >> "%LOG_FILE%"
REM For development/testing - enable test signing
bcdedit /set testsigning on >> "%LOG_FILE%" 2>&1

REM Install driver using INF file
echo Attempting driver installation via INF: %DRIVER_INF% >> "%LOG_FILE%"
rundll32.exe setupapi.dll,InstallHinfSection DefaultInstall 128 %DRIVER_INF% >> "%LOG_FILE%" 2>&1
if %errorLevel% neq 0 (
    echo WARNING: Driver installation via INF failed. ErrorLevel: %errorLevel%
    echo WARNING: Driver installation via INF failed. ErrorLevel: %errorLevel% >> "%LOG_FILE%"
    echo Attempting manual installation...
    echo Attempting manual installation... >> "%LOG_FILE%"
    
    REM Copy driver to system32\drivers
    echo Copying driver %DRIVER_PATH% to %SystemRoot%\System32\drivers\ >> "%LOG_FILE%"
    copy /Y "%DRIVER_PATH%" "%SystemRoot%\System32\drivers\" >nul
    
    REM Register driver manually
    echo Manually creating service for driver CryptoShield >> "%LOG_FILE%"
    sc create CryptoShield type= kernel start= demand binPath= "%SystemRoot%\System32\drivers\CryptoShield.sys" DisplayName= "CryptoShield Minifilter Driver" >> "%LOG_FILE%" 2>&1
) else (
    echo Driver installation via INF succeeded. >> "%LOG_FILE%"
)

echo [4/7] Installing service...
echo [4/7] Installing service... >> "%LOG_FILE%"
"%INSTALL_DIR%\CryptoShieldService.exe" /install >> "%LOG_FILE%" 2>&1
if %errorLevel% neq 0 (
    echo ERROR: Failed to install service. ErrorLevel: %errorLevel%
    echo ERROR: Failed to install service. ErrorLevel: %errorLevel% >> "%LOG_FILE%"
    pause
    exit /b 1
)
echo Service CryptoShieldService installed. >> "%LOG_FILE%"

echo [5/7] Configuring service...
echo [5/7] Configuring service... >> "%LOG_FILE%"
sc config CryptoShieldService start= auto >nul
sc description CryptoShieldService "CryptoShield Anti-Ransomware Protection Service" >nul
echo Service CryptoShieldService configured for auto start and description updated. >> "%LOG_FILE%"

echo [6/7] Setting permissions...
echo [6/7] Setting permissions... >> "%LOG_FILE%"
REM Set permissions on data directory
icacls "%DATA_DIR%" /grant "SYSTEM:(OI)(CI)F" >nul
icacls "%DATA_DIR%" /grant "Administrators:(OI)(CI)F" >nul
echo Permissions set for %DATA_DIR%. >> "%LOG_FILE%"

echo [7/7] Creating firewall exception...
echo [7/7] Creating firewall exception... >> "%LOG_FILE%"
netsh advfirewall firewall add rule name="CryptoShield Service" dir=in action=allow program="%INSTALL_DIR%\CryptoShieldService.exe" enable=yes >nul
echo Firewall rule "CryptoShield Service" created. >> "%LOG_FILE%"

echo.
echo. >> "%LOG_FILE%"
echo ===============================================
echo =============================================== >> "%LOG_FILE%"
echo Installation completed successfully!
echo Installation completed successfully! >> "%LOG_FILE%"
echo ===============================================
echo =============================================== >> "%LOG_FILE%"
echo.
echo. >> "%LOG_FILE%"

choice /C YN /M "Do you want to start the service now?"
if !errorLevel! equ 1 (
    echo Starting driver...
    echo Starting driver... >> "%LOG_FILE%"
    sc start CryptoShield >nul 2>&1
    if !errorLevel! neq 0 (
        echo WARNING: Failed to start driver CryptoShield. It will start on next reboot. ErrorLevel: !errorLevel!
        echo WARNING: Failed to start driver CryptoShield. It will start on next reboot. ErrorLevel: !errorLevel! >> "%LOG_FILE%"
    ) else (
        echo Driver CryptoShield started. >> "%LOG_FILE%"
    )
    
    echo Starting service...
    echo Starting service... >> "%LOG_FILE%"
    net start CryptoShieldService >> "%LOG_FILE%" 2>&1
    if !errorLevel! neq 0 (
        echo ERROR: Failed to start service CryptoShieldService. ErrorLevel: !errorLevel!
        echo ERROR: Failed to start service CryptoShieldService. ErrorLevel: !errorLevel! >> "%LOG_FILE%"
    ) else (
        echo.
        echo. >> "%LOG_FILE%"
        echo CryptoShield is now active and protecting your system!
        echo CryptoShield is now active and protecting your system! >> "%LOG_FILE%"
    )
)

echo.
echo Installation log saved to: %LOG_FILE%
echo Script finished on %date% at %time% >> "%LOG_FILE%"
echo.
pause