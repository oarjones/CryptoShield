@echo off
REM CryptoShield Installation Script
REM Run as Administrator

setlocal enabledelayedexpansion

echo ===============================================
echo CryptoShield Anti-Ransomware Installation
echo Version 1.0.0
echo ===============================================
echo.

REM Check for administrator privileges
net session >nul 2>&1
if %errorLevel% neq 0 (
    echo ERROR: This script must be run as Administrator!
    echo Right-click and select "Run as administrator"
    pause
    exit /b 1
)

REM Set paths
set DRIVER_PATH=%~dp0Driver\CryptoShield\x64\Release\CryptoShield.sys
set DRIVER_INF=%~dp0Driver\CryptoShield\CryptoShield.inf
set SERVICE_PATH=%~dp0Service\CryptoShieldService\x64\Release\CryptoShieldService.exe
set INSTALL_DIR=C:\Program Files\CryptoShield
set DATA_DIR=C:\ProgramData\CryptoShield

REM Check if files exist
if not exist "%DRIVER_PATH%" (
    echo ERROR: Driver file not found: %DRIVER_PATH%
    echo Please build the driver first.
    pause
    exit /b 1
)

if not exist "%SERVICE_PATH%" (
    echo ERROR: Service file not found: %SERVICE_PATH%
    echo Please build the service first.
    pause
    exit /b 1
)

echo [1/7] Creating installation directories...
if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%"
if not exist "%DATA_DIR%" mkdir "%DATA_DIR%"
if not exist "%DATA_DIR%\Logs" mkdir "%DATA_DIR%\Logs"

echo [2/7] Copying files...
copy /Y "%SERVICE_PATH%" "%INSTALL_DIR%\" >nul
if %errorLevel% neq 0 (
    echo ERROR: Failed to copy service executable
    pause
    exit /b 1
)

echo [3/7] Installing driver...
REM For development/testing - enable test signing
bcdedit /set testsigning on >nul 2>&1

REM Install driver using INF file
rundll32.exe setupapi.dll,InstallHinfSection DefaultInstall 128 %DRIVER_INF%
if %errorLevel% neq 0 (
    echo WARNING: Driver installation via INF failed
    echo Attempting manual installation...
    
    REM Copy driver to system32\drivers
    copy /Y "%DRIVER_PATH%" "%SystemRoot%\System32\drivers\" >nul
    
    REM Register driver manually
    sc create CryptoShield type= kernel start= demand binPath= "%SystemRoot%\System32\drivers\CryptoShield.sys" DisplayName= "CryptoShield Minifilter Driver"
)

echo [4/7] Installing service...
"%INSTALL_DIR%\CryptoShieldService.exe" /install
if %errorLevel% neq 0 (
    echo ERROR: Failed to install service
    pause
    exit /b 1
)

echo [5/7] Configuring service...
sc config CryptoShieldService start= auto >nul
sc description CryptoShieldService "CryptoShield Anti-Ransomware Protection Service" >nul

echo [6/7] Setting permissions...
REM Set permissions on data directory
icacls "%DATA_DIR%" /grant "SYSTEM:(OI)(CI)F" >nul
icacls "%DATA_DIR%" /grant "Administrators:(OI)(CI)F" >nul

echo [7/7] Creating firewall exception...
netsh advfirewall firewall add rule name="CryptoShield Service" dir=in action=allow program="%INSTALL_DIR%\CryptoShieldService.exe" enable=yes >nul

echo.
echo ===============================================
echo Installation completed successfully!
echo ===============================================
echo.

choice /C YN /M "Do you want to start the service now?"
if !errorLevel! equ 1 (
    echo Starting driver...
    sc start CryptoShield >nul 2>&1
    if !errorLevel! neq 0 (
        echo WARNING: Failed to start driver. It will start on next reboot.
    )
    
    echo Starting service...
    net start CryptoShieldService
    if !errorLevel! neq 0 (
        echo ERROR: Failed to start service
    ) else (
        echo.
        echo CryptoShield is now active and protecting your system!
    )
)

echo.
echo Installation log saved to: %DATA_DIR%\install.log
echo.
pause